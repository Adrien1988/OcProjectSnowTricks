{% extends 'base.html.twig' %}

{% block title %}
    {{ figure.name }} - D√©tails
{% endblock %}

{% block body %}
    {% for message in app.flashes('success') %}
        <div class="alert alert-success">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('error') %}
        <div class="alert alert-danger">{{ message }}</div>
    {% endfor %}

    <section class="container my-5">
        <!-- Image principale avec superposition du nom et les boutons Modifier/Supprimer -->
        <div class="position-relative text-center">
            {% if figure.mainImage %}
                <img src="{{ asset(figure.mainImage.url) }}" class="img-fluid w-100" alt="{{ figure.mainImage.altText|default('Image de la figure') }}">
            {% else %}
                <img src="{{ asset('build/images/default-image.jpg') }}" class="img-fluid w-100" alt="Image par d√©faut">
            {% endif %}

            <!-- Superposition du nom de la figure -->
            <div class="position-absolute bottom-0 start-0 p-3 bg-dark text-white bg-opacity-75 w-100">
                <h1 class="text-uppercase">{{ figure.name }}</h1>
            </div>

            <!-- Boutons Modifier et Supprimer pour l'image principale -->
            {% if is_granted('ROLE_USER') %}
                <div class="btn-group position-absolute top-0 end-0 p-3">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editMainImageModal">‚úèÔ∏è</button>
                    <button type="button" class="btn btn-danger btn-sm">üóëÔ∏è</button>
                </div>
            {% endif %}
        </div>

        <!-- Modale de modification de l'image principale -->
        <div class="modal fade" id="editMainImageModal" tabindex="-1" aria-labelledby="editMainImageModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editMainImageModalLabel">Modifier l'image principale</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {{ form_start(mainImageForm, {
                            'action': path('app_figure_set_main_image', { id: figure.id }),
                            'method': 'POST'
                        }) }}

                        <div class="mb-3 text-center">
                            <label class="form-label">S√©lectionnez l'image principale</label>
                            <div class="d-flex flex-wrap justify-content-center gap-3" id="imageSelectionContainer">
                                {% for image in figure.images %}
                                    <label class="d-block text-center image-label" style="cursor: pointer;">
                                        <input type="radio" name="{{ mainImageForm.mainImage.vars.full_name }}" value="{{ image.id }}" {% if figure.mainImage == image %}checked{% endif %} style="display: none;">
                                        <img src="{{ asset(image.url) }}" class="img-thumbnail border {% if figure.mainImage == image %}border-primary{% endif %}" alt="Image principale" style="width: 120px; height: 120px; object-fit: cover;">
                                    </label>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                            {{ form_widget(mainImageForm.save) }}
                        </div>

                        {{ form_end(mainImageForm) }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Description -->
        <div class="mt-4">
            <h5 class="text-uppercase">Description</h5>
            <p>{{ figure.description }}</p>

            <h5 class="text-uppercase">Groupe</h5>
            <p>{{ figure.figureGroup }}</p>
        </div>

        <!-- Section des commentaires -->
        <div class="mt-5">
            <h5 class="text-uppercase">Commentaires</h5>
            {% if comments is not empty %}
                <div>
                    {% for comment in comments %}
                        <div class="border p-3 mb-3 rounded">
                            <div class="d-flex align-items-center mb-2">
                                <strong>{{ comment.author.username }}</strong>
                                <small class="text-muted ms-3">{{ comment.createdAt|date('d/m/Y H:i') }}</small>
                            </div>
                            <p>{{ comment.content }}</p>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">Aucun commentaire disponible pour cette figure.</p>
            {% endif %}

            <!-- Formulaire pour ajouter un commentaire -->
            {% if is_granted('ROLE_USER') %}
                <div class="mt-4">
                    <h5 class="text-uppercase">Ajouter un commentaire</h5>
                    {% if form_errors(commentForm) %}
                        <div class="alert alert-danger">
                            {{ form_errors(commentForm) }}
                        </div>
                    {% endif %}
                    {{ form_start(commentForm, { 'action': path('app_figure_add_comment', { 'id': figure.id }), 'method': 'POST' }) }}
                    {{ form_widget(commentForm) }}
                    <div class="d-grid mt-3">
                        <button type="submit" class="btn btn-primary">Publier</button>
                    </div>
                    {{ form_end(commentForm) }}
                </div>
            {% endif %}
        </div>
    </section>

    <!-- Script JavaScript pour g√©rer la s√©lection des images et √©viter le double affichage -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const labels = document.querySelectorAll(".image-label");

            labels.forEach(label => {
                label.addEventListener("click", function () {
                    // Retirer la classe "border-primary" de toutes les images
                    labels.forEach(l => l.querySelector("img").classList.remove("border-primary"));

                    // Ajouter la classe "border-primary" √† l'image s√©lectionn√©e
                    this.querySelector("img").classList.add("border-primary");

                    // Cocher le bouton radio associ√©
                    this.querySelector("input[type='radio']").checked = true;
                });
            });
        });
    </script>
{% endblock %}
